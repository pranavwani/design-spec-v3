---
layout: base
---

{%- comment -%}
Pick collection (main specs vs drafts) based on the page’s collection.
{%- endcomment -%}
{%- assign col_name = page.collection | default: 'specs' -%}
{%- if col_name == 'draft_specs' -%}
  {%- assign col = site.draft_specs -%}
{%- else -%}
  {%- assign col = site.specs -%}
{%- endif -%}

{%- comment -%}
Resolve the space root robustly:
- page.dir is the URL directory (always ends with /), so it’s the space root for both index and non-index pages.
- space_index is the index page for header metadata pills.
{%- endcomment -%}
{%- assign root = page.dir -%}
{%- assign space_index = col | where: "url", root | first -%}
{%- assign meta = space_index | default: page -%}

<header class="spec-header">
  <a class="back" href="{{ '/' | relative_url }}">← Back</a>
  <h1 class="spec-heading">{{ page.title }}</h1>
  <div class="spec-header-right">
    {%- if meta.epic -%}
      {%- assign _epic = meta.epic | strip -%}
      {%- if site.jira and site.jira.base_url -%}
        <a class="pill pill--muted" href="{{ site.jira.base_url | append: '/' | append: _epic }}" target="_blank" rel="noopener">Epic {{ _epic }}</a>
      {%- else -%}
        <span class="pill pill--muted">Epic {{ _epic }}</span>
      {%- endif -%}
    {%- endif -%}

    {%- if meta.spec_version -%}<span class="pill">Spec v{{ meta.spec_version }}</span>{%- endif -%}
    {%- if meta.stage -%}<span class="pill pill--muted">{{ meta.stage | upcase }}</span>{%- endif -%}
    {%- if meta.status -%}<span class="pill pill--{{ meta.status | downcase }}">{{ meta.status | capitalize }}</span>{%- endif -%}
    {%- if meta.updated_at -%}<span class="pill pill--muted">Updated {{ meta.updated_at }}</span>{%- endif -%}

    {%- if meta.owner -%}
      {%- assign _owner = meta.owner | strip -%}
      {%- if _owner | slice: 0, 1 == '@' -%}
        {%- assign _handle = _owner | remove: '@' -%}
        <a class="pill pill--muted" href="https://github.com/{{ _handle | uri_escape }}" target="_blank" rel="noopener">Owner {{ _owner }}</a>
      {%- else -%}
        <span class="pill">Owner {{ _owner }}</span>
      {%- endif -%}
    {%- endif -%}

    {%- if meta.team -%}<span class="pill">Team {{ meta.team }}</span>{%- endif -%}
    {%- if meta.created_at -%}<span class="pill pill--muted">Created {{ meta.created_at }}</span>{%- endif -%}
    {%- if meta.pr_url and meta.pr -%}<a class="pill pill--muted" href="{{ meta.pr_url }}" target="_blank" rel="noopener">PR #{{ meta.pr }}</a>{%- endif -%}
  </div>
</header>

{%- comment -%}
Build the left nav from files in the SAME directory (top-level only).
Using path ensures we don’t cross collections or pull in other folders.
{%- endcomment -%}
{%- assign space_dir = page.path | replace: page.name, '' -%}
{%- assign docs = col | where_exp:'d', "d.path contains space_dir" -%}

{%- assign normalized = "" | split: "" -%}
{%- assign order_map = "overview:0|hld:10|lld:20|data-model:25|api:30|ux:40|rollout-ops:50|qa-test:60" | split:"|" -%}

{%- for d in docs -%}
  {%- assign depth = d.path | remove_first: space_dir | split:'/' | size -%}
  {%- if depth > 1 -%}{% continue %}{%- endif -%}

  {%- assign href = d.url | replace: '/index.html','/' -%}
  {%- assign rel  = d.path | remove_first: space_dir -%}
  {%- assign slug = rel | replace: 'index.md','overview' | replace: '.md','' | downcase -%}

  {%- assign label = d.nav_title | default: d.title -%}
  {%- if label == nil or label == "" -%}
    {%- case slug -%}
      {%- when 'overview' -%}{%- assign label = 'Overview' -%}
      {%- when 'hld' -%}{%- assign label = 'High-Level Design' -%}
      {%- when 'lld' -%}{%- assign label = 'Low-Level Design' -%}
      {%- when 'data-model' -%}{%- assign label = 'Data Model' -%}
      {%- when 'api' -%}{%- assign label = 'API' -%}
      {%- when 'ux' -%}{%- assign label = 'UX' -%}
      {%- when 'rollout-ops' -%}{%- assign label = 'Rollout & Ops' -%}
      {%- when 'qa-test' -%}{%- assign label = 'QA / Test Plan' -%}
      {%- else -%}{%- assign label = slug | replace:'-',' ' | capitalize -%}
    {%- endcase -%}
  {%- endif -%}

  {%- assign order = d.nav_order -%}
  {%- if order == nil or order == "" -%}
    {%- assign mapped = 999 -%}
    {%- for p in order_map -%}
      {%- assign k = p | split:':' | first -%}
      {%- assign v = p | split:':' | last  -%}
      {%- if slug == k -%}{%- assign mapped = v -%}{%- endif -%}
    {%- endfor -%}
    {%- assign order = mapped -%}
  {%- endif -%}

  {%- assign active = page.url == d.url -%}
  {%- assign item = '{"href":"__H__","label":"__L__","order":__O__,"active":__A__}'
      | replace:'__H__', href
      | replace:'__L__', label
      | replace:'__O__', order
      | replace:'__A__', active -%}
  {%- assign normalized = normalized | push: item -%}
{%- endfor -%}

{%- assign sorted = normalized | sort: 'order' -%}

<div class="spec-grid">
  <aside class="sidebar">
    <nav class="sidebar-nav">
      <ul class="side-links">
        {%- for json in sorted -%}
          {%- assign obj = json | parse_json -%}
          <li>
            <a href="{{ obj.href | relative_url }}"
               class="{% if obj.active %}active{% endif %}"
               {% if obj.active %}aria-current="page"{% endif %}>
              {{ obj.label }}
            </a>
          </li>
        {%- endfor -%}
      </ul>
    </nav>
  </aside>

  <main id="spec-content" class="content">
    <article class="content-card">
      {{ content }}
    </article>
  </main>
</div>

<script>
  // PJAX-lite: keep header + leftbar static while swapping right pane.
  (function () {
    const containerSel = '#spec-content';
    const navSel = '.sidebar-nav a, .side-links a';

    function sameOrigin(href) {
      try { return new URL(href, location.href).origin === location.origin; }
      catch { return false; }
    }

    function setActive(absHref) {
      document.querySelectorAll(navSel).forEach(a => {
        const match = new URL(a.href, location.href).href === absHref;
        a.classList.toggle('active', match);
        if (match) a.setAttribute('aria-current', 'page');
        else a.removeAttribute('aria-current');
      });
    }

    async function load(href, { push = true, scroll = true } = {}) {
      const abs = new URL(href, location.href).href;
      const res = await fetch(abs, { headers: { 'X-PJAX': '1' } });
      if (!res.ok) throw new Error('Fetch failed: ' + abs);

      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const next = doc.querySelector(containerSel);
      const curr = document.querySelector(containerSel);
      if (!next || !curr) return location.assign(abs);

      curr.style.opacity = '0.35';
      curr.replaceWith(next);
      next.style.opacity = '1';

      if (doc.title) document.title = doc.title;
      setActive(abs);
      if (scroll) next.scrollIntoView({ block: 'start' });
      if (push) history.pushState({ pjax: true, url: abs }, '', abs);
    }

    document.addEventListener('click', (e) => {
      const a = e.target.closest(navSel);
      if (!a) return;
      if (e.defaultPrevented || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

      const href = a.getAttribute('href');
      if (!href || href.startsWith('#') || !sameOrigin(href)) return;

      e.preventDefault();
      load(href).catch(() => location.assign(href));
    });

    window.addEventListener('popstate', (e) => {
      if (e.state && e.state.pjax && e.state.url) {
        load(e.state.url, { push: false }).catch(() => location.reload());
      }
    });

    setActive(location.href);
  })();
</script>
